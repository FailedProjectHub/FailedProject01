<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta http-equiv="X-UA-Compatible" value="IE=9">
        <link rel="stylesheet" href="/static/ABPlayerHTML5/build/css/base.css?1"/>
		<title>New Interface Test for ABPlayer</title>
		<script src="/static/ABPlayerHTML5/build/js/ABPMobile.js"></script>
		<script src="/static/ABPlayerHTML5/build/js/CommentCoreLibrary.min.js"></script>
		<script src="/static/ABPlayerHTML5/build/js/ABPLibxml.js"></script>
		<script src="/static/ABPlayerHTML5/build/js/ABPlayer.js"></script>
        <script src="/static/jquery/js/jquery.min.js"></script>
        <script> document.write("<script src=\"http:\/\/" + window.location.hostname + ":4000/socket.io/socket.io.js\"><\/script>"); </script>
		<script type="text/javascript">
			$(function(){
                // websocket
                var socket = new io.connect("http:\/\/" + window.location.hostname + ":4000/");
                var owner = "{{token}}";

                // enter channel
                socket.emit("enter_channel", "{{token}}");

				var inst = ABP.bind(document.getElementById("player"), isMobile());
           
                $.get("/danmaku/{{token}}", function(data, status) {
                    if (status!="success") {
                        console.log("Network Error: "+status);
                        return;
                    }
                    var res = eval(data);
                    var cdata = new Array();
                    for (var i=0;i<res.length;++i) {
                        cdata.push(new CoreComment(cm, res[i]));
                    }
                    cm.load(cdata);
                });

                //subscribe live danmaku
                socket.on("live_danmaku", function(danmaku){
                        console.log(danmaku);
                        cm.load([danmaku]);
                });

                inst.scripting = true;
                inst.cmManager.start();
                var cm = inst.cmManager;
				$(inst.txtText).keyup(function(event){
					if( event.which === 13){

                        var danmaku={
                            "owner": owner,
                            "mode": 1,
                            "stime": parseInt(inst.video.currentTime*1000)+500,//to prevent dm not showing
                            "text": $(inst.txtText).val(),
                            "cindex": 0,
                            "motion": [],
                            "size": 25,
                            "color": 0xffffff,
                        };
                        /*
                        cm.send(danmaku);
                        */
                        socket.emit("send_danmaku", danmaku);

                        $(inst.txtText).val("");
					}
				});
			});
		</script>
	</head>
	<body>
		<div id="player" class="ABP-Unit" style="width:640px;height:480px;" tabindex="1">
			<div class="ABP-Video">
				<div class="ABP-Container" id="player"></div>
				<video id="abp-video" autobuffer="true" data-setup="{}">
                <source src="/download/{{token}}" type="video/mp4" value={{token}}>
					<p>Your browser does not support html5 video!</p>
				</video>
			</div>
            <div class="ABP-Time"></div>
			<div class="ABP-Text">
				<input type="text" id="danmakutext">
			</div>
			<div class="ABP-Control">
				<div class="button ABP-Play"></div>
				<div class="progress-bar">
					<div class="bar dark"></div>
					<div class="bar"></div>
				</div>
				<div class="button ABP-CommentShow"></div>
				<div class="button ABP-FullScreen"></div>
			</div>
		</div>
		<div id="toBeInjected"></div>
	</body>
</html>
